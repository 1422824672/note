## 硬件结构

#### 1.CPU如何执行程序

##### 图灵机工作方式

图灵机基本组成：

- 一条无限长的纸带，写入字符
- 读写头，读取任意格子字符，写入任意格子字符
- 读写头有一些部件
  - 存储单元存放数据
  - 控制单元识别字符是数据还是指令，控制程序流程
  - 运算单元用于执行运算指令

****

##### 冯诺依曼模型

冯诺依曼依据图灵机提出了计算机具体实现的报告，定义计算机基本结构5个部分：中央处理器（CPU）、内存、输入设备、输出设备、总线

- **内存** 存储区域呈线性排列，从0开始，最小存储单位为字节，1 byte = 8 bit
- **中央处理器（CPU）** 32位一次可以计算4个字节，64位一次可以计算8个字节，这里的位通常指位宽
- **总线** 地址总线负责指定操作的内存地址；数据总线读写数据；控制总线用于发送和接收信号。
- **输入、输出设备** 例如键盘，通过控制总线，和CPU进行交互

****

##### 线路位宽与CPU位宽

- **线路位宽** 低电压代表0，高电压代表1，每条线路传递1bit数据，`2^32=4G`32条则可以操作4G内存。

- 32位最多可以在4G内存中寻址，64位则可以在128G内存中寻址

****

##### 程序执行基本过程

1.CPU读取程序计数器中所需指令的内存地址，再将读取后的指令数据放入指令寄存器

2.判断指令类型和参数，计算类型交给逻辑运算单元， 存储类型交给控制单元

3.程序计数器根据CPU位数自增来达到指向下一条指令的操作

这种不断循环直到程序结束的过程称为CPU的**生命周期**

****

##### a=1+2执行具体过程

1.高级语言编译成汇编代码

2.汇编代码通过汇编器翻译成机器码

CPU中执行过程：

1.编译器将数据存入内存中的数据段

2.编译器将指令存入内存中的正文段

- 存储指令会将数据段中的指定数据放入寄存器中
- 计算指令会将放入寄存器中的数据进行操作，把结果放到寄存器中
- 存储指令将寄存器中的数据放回内存中的数据段中，这个地址为a的内存地址

****

##### 指令

每条指令有对应的机器码，不同CPU有不同的指令集

MIPS指令为32位的整数，高6位代表操作码，剩下的26位分为R、I、J类型

- R用于算术和逻辑操作
- I用于数据传输
- J用于跳转

CPU4级流水线：

1.Fetch（取得指令）控制器操作

2.Decode（指令译码）控制器操作

3.Execution（执行指令）运算器操作

4.Store（数据回写）控制器操作

以上为CPU的一个指令周期

****

##### 指令的类型

- 数据传输指令
- 运算类型指令
- 跳转类型指令
- 信号类型指令
- 闲置类型指令

*****

##### 指令的执行速度

1GHZ 代表着CPU一秒会产生1G次数的脉冲信号

一次脉冲信号高低电平转换则为一个时钟周期

> 如何让程序跑的更快

`程序的CPU执行时间 = CPU时钟周期数 * 时钟周期时间`

2.4GHz的时钟周期时间：1/2.4G

 `CPU时钟周期数 = 指令数 * 每条指令的平均时钟周期数(CPI)`

- 指令数基本靠编译器优化
- CPU通过流水线技术让周期数减少
- 时钟周期时间表示计算机主频，如果CPU有超频技术，则可以超频，但是会给CPU带来压力，容易崩溃

*****

##### 64位CPU相比32位CPU优势

- 运算大数字的时候，超过32位的数字32位CPU需要分步进行
- 64位寻址内存空间更大

64位软件和32位软件实际代表指令是64位还是32位的

*****

#### 2.存储器金字塔

##### 存储器层次结构

CPU存储结构有 寄存器、CPU L1/L2/L3/ Cache等

- 存储器的层次结构

​	处理速度：CPU寄存器 > CPU L1/L2/L3 Cache > 内存 > 硬盘

​	存储容量：与处理速度相反

**寄存器**

一般要求在半个CPU时钟周期内完成读写

**CPU Cache**

使用的SRAM芯片，静态随机存储器

1 bit通常需要6个晶体管

L1/L2/L3 为一级缓存、二级缓存和三级缓存

每个CPU核心都有一块自己的L1高速缓存 指令缓存和数据缓存是在L1分开存储 速度大概2~3个时钟周期

每个CPU核心也有L2 Cache 速度大概10~20个时钟周期

L3则通常为多个CPU核心共用的 访问速度大概在20~60个时钟周期

**内存**

使用的是DRAM芯片，动态随机存取存储器

DRAM存储 1bit 数据通常只需要一个晶体管和一个电容就能存储，动态的定时刷新电容保证数据不会被丢失

内存速度大概在200~300个时钟周期

**SSD/HDD硬盘**

SSD固态硬盘，结构和内存类似，内存读写速度大概是SSD的10~1000倍

HDD机械硬盘，他的速度比内存慢10W倍左右

****

##### 存储器的层次关系

CPU不会和每种存储器打交道，而是一种存储设备和相邻储存设备打交道

这种层次结构也构成了缓存体系

****

##### 存储器之间的实际价格和性能差距

- SSD比机械硬盘快70倍左右
- 内存比机械硬盘快100000倍左右
- CPU L1 Cache比机械硬盘快10000000倍左右

****

#### 3.如何写出让CPU跑得更快的代码

##### CPU Cache 有多快

 为了弥补CPU与内存之间速度差异，引入了CPU Cache

CPU通过自上而下访问Cache

因此Cache相比内存快100多倍

****

##### CPU Cache的数据结构和读取过程

CPU Cache 一小块一小块读取数据，一块称为 Cache Line，内存中的一小块称为Block，内存块。

- 直接映射Cache 将内存块地址映射在一个CPU Line的地址上

例如访问内存块中的第15块时，CPU Line有8块，如果数据已经缓存则必缓存在15 % 8 = 7，也就是第7块上。

为了区别不同区块，则会在CPU Line中存储一个组标记。

CPU Line还会存储有效位，当有效位为0，无论CPU Line中是否有数据，CPU都会直接访问内存，重新加载数据。

CPU读取CPU Line中所需要的数据片段，这个片段统称为一个字。通过偏移量找到CPU Line中CPU所需要的字。

****

##### 何写出让CPU跑得更快的代码

访问数据在CPU Cache中，意味着缓存命中

CPU从内存中连续加载元素到Cache中，加载大小跟Cache Line有关

因此提升数据再内存中顺序布局，则可以提高缓存命中

分支预测器会将可能执行的语句提前缓存到Cache中，因此先排序再遍历会比先遍历再排序要快

##### 如何提升多核CPU的缓存命中率

将计算密集型线程绑定到指定的一个CPU核心上，防止在多个CPU上同步

****

#### 4.CPU缓存一致性

##### CPU Cache的数据写入

- 写直达 数据同时写入内存和Cache中

- 写回 当发生写操作时，新数据仅被写入Cache Block中，当修改过的Cache Block被替换才写入到内存中

  ****

##### 缓存一致性问题

- 写传播
- 事务串形化

****

##### 总线嗅探

CPU监听总线上的一切活动，无论自己的Cache是否缓存里相同的数据，都要发出广播时间，无疑加重总线的负载

****

##### MESI协议

- Modified，已修改
- Exclusive，独占
- Shared，共享
- Invalidated，已失效

****

#### 5.CPU如何执行任务

CPU Cache伪共享

两个数据 long A、B物理地址连续，读取时只想读A，则可能将B也读取，另一个核心想读B，可能将A也读取，称作伪共享
