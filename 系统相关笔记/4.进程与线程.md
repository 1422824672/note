## 进程与线程

#### 1.进程、线程基础知识

##### 进程

运行中的程序，被称为进程

多个程序、交替执行，就是CPU管理多个进程的初步想法

CPU一秒钟可能运行多个进程，会产生并行的错觉，实际上是并发

****

##### 进程的状态

三种基本状态：运行状态、就绪状态、阻塞状态（因为输入输出等操作不能继续进行，即使给予CPU也不能操作）

基本状态：创建状态和结束状态

阻塞会进入到就绪状态，而非回到运行状态

描述进程没有占用实际的物理内存空间的情况，这个状态就是挂起状态

- 阻塞挂起状态
- 就绪挂起状态

以下情况也可能挂起：

- 通过sleep挂起
- 主动挂起程序执行

****

##### 进程的控制结构

- 进程控制块（PCB）数据结构来描述进程

> PCB包含的信息

进程描述信息：

- 进程标识符
- 用户标识符

进程控制和管理信息：

- 进程当前状态
- 进程优先级

资源分配清单

CPU相关信息

> 每个PCB是如何组织的

通常通过链表组织，组成各种队列，例如：

- 处于就绪状态的进程链在一起，称为就绪队列

除了链接的组织方式，还有索引方式，工作原理是将同一状态的进程组织在一个索引表中

****

##### 进程的控制

- 创建进程 允许一个进程创建另一个进程
- 终止进程 分为三种终止方式 正常结束、异常结束以及外界干预
- 阻塞进程
- 唤醒进程 与阻塞进程相对应

****

##### 进程的上下文切换

一个进程切换到另一个进程，称为进程的上下文切换

操作系统需要实现帮CPU设置好CPU寄存器和程序计数器

> 进程的上下文切换

****

##### 线程

> 为什么使用线程？

- 实体之间可以并发运行
- 实体之间共享相同的地址空间

线程之间可以并发运行并且共享相同的地址空间

数据流可以共享，控制流相对独立

> 线程的优缺点？

优点：

- 一个进程可以同时存在多个线程
- 各个线程之间可以并发执行
- 各个线程之间可以共享地址空间和文件等资源

缺点：

- 一个线程崩，所属进程其余线程全部崩

****

##### 线程与进程的比较

- 进程是资源分配单位，线程是CPU调度的单位
- 进程拥有一个完整的资源平台，而线程只独享必不可少的资源，如寄存器和栈
- 线程同样具有就绪、阻塞、执行三种基本状态，同样具有状态之间的转换关系
- 线程能减少并发执行的时间和空间开销

****

##### 线程的上下文切换

线程是调度的基本单位，而进程则是资源拥有的基本单位

- 当两个线程不是属于同一个进程，则切换的过程就跟进程上下文切换一样
- 当两个线程是同属于一个进程，所以切换时只需要切换线程的私有数据、寄存器等不共享的数据

****

##### 线程的实现

- 用户线程
- 内核线程
- 轻量级进程

线程控制块TCB存在于用户态的线程管理库来实现的，用户线程的整个线程管理和调度，操作系统是不直接参与的，而是由用户级线程库函数来完成线程的管理，包括线程的创建、终止、同步和调度等

用户线程的优点：

- TCB有用户级库函数来维护，可用于不支持线程技术的操作系统
- 用户线程的切换也是由线程库函数来完成的，所以速度特别快

用户线程的缺点：

- 如果一个线程发起了系统调用而阻塞，那进程所包含的用户线程都不能执行了
- 当一个线程开始运行后，除非它主动地交出CPU的使用权，否则它所在的进程当中的其他线程无法运行
- 由于时间片分配给进程，当进程在多线程执行的时候，每个线程得到的时间片较少，执行会比较慢

> 内核线程如何理解？

内核线程由操作系统来管理，线程对应的TCP自然也是放在操作系统里的，这样线程的创建、终止和管理都是由操作系统负责

内核线程的优点：

- 其中一个线程阻塞，不会影响其他内核线程的运行
- 分配给线程，多线程的进程获得更多的CPU运行时间

内核线程的缺点：

- 在支持内核线程的操作系统中，由内核来维护进程和线程的上下文信息，如PCB和TCB
- 线程的创建、终止和切换都是通过系统调用的方式来进行，因此对于操作系统来说，系统开销比较大

> 轻量级进程如何理解？

轻量级进程LWP是内核支持的用户线程，一个进程可有一个或多个LWP，每个LWP是跟内核线程一对一映射的，也就是LWP都是由一个内核线程支持

LWP与普通进程的区别也在于它只有一个最小的执行上下文和调度程序所需的统计信息

****

##### 调度

选择一个进程运行这一功能是在操作系统中完成的，通常称为调度程序

****

##### 调度时机

当进程从一个运行状态到另外一状态变化的时候，会触发一次调度

根据如何处理时钟中断，把调度算法分为两类：

- 非抢占式调度算法
- 抢占式调度算法

****

##### 调度原则

- 原则一： 为了提高CPU利用率，在发送IO事件致使CPU空闲的情况下，调度程序需要从就绪队列中选择一个进程来运行
- 原则二：提高系统的吞吐率，调度程序要权衡长任务和短任务进程的运行完成数量
- 原则三：如果进程的等待时间很长而运行时间很短，那周转时间就很长，这不是我们所期望的，调度程序应该避免这种情况发生
- 原则四：就绪队列中进程的等待时间也是调度程序所需要考虑的原则
- 原则五：对于交互式比较强的应用，响应时间也是调度程序需要的考虑的原则

针对上面的五种调度原则，总结成如下：

- CPU的利用率
- 系统吞吐量
- 周转时间
- 等待时间
- 响应时间

****

##### 调度算法

> 01 先来先服务调度算法（FCFS）

每次从就绪队列选择最先进入队列的进程，然后一直运行，直到进程退出或被阻塞，才会继续从队列中选择第一个进程接着运行

> 02 最短作业优先调度算法（SJF）

优先选择运行时间最短的进程来进行，有助于提高系统的吞吐量

> 03 高响应比优先调度算法（HRRN）

每次进行进程调度时，先计算响应比优先级，然后把响应比优先级最高的进程投入运行

优先权 = 等待时间+要求服务时间/要求服务时间

这样就兼顾了短作业和长作业

> 04 时间片轮转调度算法（RR）

每个进程被分配一个时间段，称为时间片，即允许该进程在该时间段中运行

